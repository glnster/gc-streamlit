#!/usr/bin/env bash

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

# Ensure .env exists
ensure_env() {
    if [ ! -f .env ]; then
        warn ".env not found, copying from .env.example"
        cp .env.example .env
    fi
}

# Commands
cmd_dev() {
    info "Starting development environment..."
    ensure_env
    docker-compose up --build -d
    info "Development server running at http://localhost:8501"
    info "Logs: ./dock logs"
}

cmd_stop() {
    info "Stopping all containers..."
    docker-compose down
    docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
    info "Containers stopped"
}

cmd_prod() {
    info "Starting production environment..."
    ensure_env
    docker-compose -f docker-compose.prod.yml up --build -d
    info "Production server running at http://localhost:80"
    info "For HTTPS, uncomment nginx service in docker-compose.prod.yml and add SSL certs"
}

cmd_rebuild() {
    local target="${1:-dev}"
    info "Rebuilding $target environment..."

    if [ "$target" = "dev" ]; then
        docker-compose down
        docker-compose build --no-cache
        docker-compose up -d
    elif [ "$target" = "prod" ]; then
        docker-compose -f docker-compose.prod.yml down
        docker-compose -f docker-compose.prod.yml build --no-cache
        docker-compose -f docker-compose.prod.yml up -d
    else
        error "Unknown target: $target. Use 'dev' or 'prod'"
    fi

    info "Rebuild complete"
}

cmd_test() {
    info "Running tests..."
    docker-compose exec streamlit pytest "$@"
}

cmd_lint() {
    info "Running linter..."
    docker-compose exec streamlit ruff check app/ tests/
}

cmd_format() {
    info "Formatting code..."
    docker-compose exec streamlit ruff format app/ tests/
    info "Code formatted"
}

cmd_logs() {
    docker-compose logs -f "${1:-streamlit}"
}

cmd_shell() {
    info "Opening shell in container..."
    docker-compose exec streamlit /bin/bash
}

cmd_clean() {
    warn "This will remove all containers, volumes, and images. Continue? (y/N)"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        info "Cleaning up..."
        docker-compose down -v
        docker-compose -f docker-compose.prod.yml down -v 2>/dev/null || true
        docker system prune -af --volumes
        info "Cleanup complete"
    else
        info "Cancelled"
    fi
}

cmd_help() {
    cat << EOF
Docker Helper Script for GC Streamlit

Usage: ./dock <command> [options]

Commands:
  dev              Start development environment with hot-reload
  stop             Stop all running containers
  prod             Start production environment
  rebuild [target] Rebuild containers (target: dev|prod, default: dev)
  test [args]      Run pytest tests (pass additional args to pytest)
  lint             Run ruff linter
  format           Format code with ruff
  logs [service]   Show logs (default: streamlit)
  shell            Open bash shell in container
  clean            Remove all containers, volumes, and images
  help             Show this help message

Examples:
  ./dock dev                    # Start development server
  ./dock test                   # Run all tests
  ./dock test tests/test_app.py # Run specific test file
  ./dock logs                   # Follow logs
  ./dock rebuild prod           # Rebuild production image
  ./dock shell                  # Open shell in container

EOF
}

# Main command router
main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        dev)
            cmd_dev
            ;;
        stop)
            cmd_stop
            ;;
        prod)
            cmd_prod
            ;;
        rebuild)
            cmd_rebuild "$@"
            ;;
        test)
            cmd_test "$@"
            ;;
        lint)
            cmd_lint
            ;;
        format)
            cmd_format
            ;;
        logs)
            cmd_logs "$@"
            ;;
        shell)
            cmd_shell
            ;;
        clean)
            cmd_clean
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            error "Unknown command: $command. Use './dock help' for usage."
            ;;
    esac
}

main "$@"
